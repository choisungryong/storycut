<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klippa - AI Video Creation Studio</title>
    <link rel="stylesheet" href="/static/css/design-tokens.css">
    <link rel="stylesheet" href="/static/css/shared.css">
    <link rel="stylesheet" href="/static/css/app.css?v=20260216_1210">
    <script src="/static/auth.js"></script>
</head>

<body class="app-body">
    <!-- Ambient background glow -->
    <div class="app-bg-glow"></div>

    <!-- ═══ FIXED NAVIGATION ═══ -->
    <nav class="sc-nav app-nav" id="appNav">
        <div class="sc-nav__inner">
            <a href="/" class="sc-nav__logo">
                <img src="/static/assets/klippa-logo.png" alt="Klippa" class="sc-nav__logo-img">
            </a>
            <div class="app-nav__tabs">
                <a href="#" id="nav-create" class="app-nav__tab active nav-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/><path d="M7 2v20M17 2v20M2 12h20"/></svg>
                    <span data-i18n="nav.create">New Video</span>
                </a>
                <a href="#" id="nav-mv" class="app-nav__tab nav-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    <span data-i18n="nav.mv">Music Video</span>
                </a>
                <a href="#" id="nav-history" class="app-nav__tab nav-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
                    <span data-i18n="nav.history">My Videos</span>
                </a>
            </div>
            <div class="app-nav__right">
                <a href="/pricing.html" class="app-nav__link" data-i18n="nav.pricing">Pricing</a>
            </div>
        </div>
    </nav>

    <!-- ═══ MAIN CONTENT ═══ -->
    <main class="app-main">

        <!-- ══════════════════════════════════════
             INPUT SECTION
             ══════════════════════════════════════ -->
        <div id="input-section" class="section">
            <div class="app-form-container">
                <div class="app-section-header">
                    <span class="section-label" data-i18n="input.label">Create</span>
                    <h2 class="section-title" data-i18n="input.title">New Video</h2>
                    <p class="section-subtitle" data-i18n="input.subtitle">Enter a topic and let AI generate a complete video with narration, images, and effects.</p>
                </div>

                <form id="generate-form" class="app-form">
                    <!-- Mode Toggle -->
                    <div class="app-card">
                        <div class="form-group">
                            <div id="mode-toggle" class="mode-toggle">
                                <button type="button" id="mode-ai-story" class="mode-toggle-btn active" data-i18n="input.mode_ai">
                                    AI Story
                                </button>
                                <button type="button" id="mode-direct-script" class="mode-toggle-btn" data-i18n="input.mode_script">
                                    Direct Script
                                </button>
                            </div>
                        </div>

                        <!-- AI Story: Topic -->
                        <div id="ai-story-inputs" class="form-group">
                            <label for="topic" data-i18n="input.topic_label">Topic / Idea</label>
                            <input type="text" id="topic" name="topic"
                                data-i18n-placeholder="input.topic_placeholder"
                                placeholder="e.g. A mysterious diary found in an old abandoned hospital"
                                class="form-input" />
                            <small class="helper-text" data-i18n="input.topic_hint">Leave blank for AI to auto-generate a topic</small>
                            <label class="toggle-item" style="margin-top:10px">
                                <input type="checkbox" name="include_dialogue" id="include_dialogue">
                                <span class="toggle-switch"></span>
                                <span class="toggle-label">
                                    <span>대화 포함</span>
                                    <small>캐릭터 간 대화가 포함된 시나리오 (남/여 화자 분리)</small>
                                </span>
                            </label>
                        </div>

                        <!-- Direct Script -->
                        <div id="direct-script-inputs" class="form-group" style="display:none">
                            <label for="direct-script" data-i18n="input.script_label">Narration Script</label>
                            <textarea id="direct-script" rows="10"
                                data-i18n-placeholder="input.script_placeholder"
                                placeholder="Paste your narration script here.&#10;&#10;Separate scenes with blank lines.&#10;&#10;Example:&#10;A thriving business among failing stores.&#10;Welcome to the Business Lab.&#10;&#10;The store we introduced last time&#10;received a huge response."
                                class="form-input form-textarea"></textarea>
                            <small class="helper-text" data-i18n="input.script_hint">Separate scenes with blank lines. AI generates matching images for each scene.</small>
                        </div>
                    </div>

                    <!-- Style & Genre -->
                    <div class="app-card">
                        <div class="app-card-label" data-i18n="input.style_genre">Style & Genre</div>
                        <div class="form-grid-2">
                            <div class="form-group">
                                <label for="genre" data-i18n="input.genre">Genre</label>
                                <div class="select-wrapper">
                                    <select id="genre" name="genre" class="form-select">
                                        <option value="emotional">Emotional</option>
                                        <option value="mystery" selected>Mystery</option>
                                        <option value="thriller">Thriller</option>
                                        <option value="fantasy">Fantasy</option>
                                        <option value="horror">Horror</option>
                                        <option value="comedy">Comedy</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="mood" data-i18n="input.mood">Mood</label>
                                <div class="select-wrapper">
                                    <select id="mood" name="mood" class="form-select">
                                        <option value="dramatic" selected>Dramatic</option>
                                        <option value="melancholic">Melancholic</option>
                                        <option value="suspenseful">Suspenseful</option>
                                        <option value="heartwarming">Heartwarming</option>
                                        <option value="dark">Dark</option>
                                        <option value="cheerful">Cheerful</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-grid-2">
                            <div class="form-group">
                                <label for="style" data-i18n="input.style">Visual Style</label>
                                <div class="select-wrapper">
                                    <select id="style" name="style" class="form-select">
                                        <option value="cinematic, high contrast" selected>Cinematic</option>
                                        <option value="realistic">Realistic</option>
                                        <option value="illustration">Illustration</option>
                                        <option value="anime">Anime</option>
                                        <option value="webtoon">Webtoon</option>
                                        <option value="game_anime">Game Anime</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="character_ethnicity" data-i18n="input.ethnicity">Character Ethnicity</label>
                                <div class="select-wrapper">
                                    <select id="character_ethnicity" name="character_ethnicity" class="form-select">
                                        <option value="auto" selected>AI Auto</option>
                                        <option value="korean">Korean</option>
                                        <option value="japanese">Japanese</option>
                                        <option value="chinese">Chinese</option>
                                        <option value="southeast_asian">Southeast Asian</option>
                                        <option value="european">European</option>
                                        <option value="black">Black</option>
                                        <option value="hispanic">Hispanic</option>
                                        <option value="mixed">Mixed</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden default voice (used as fallback) -->
                    <input type="hidden" id="voice" name="voice" value="uyVNoMrnUku1dZyVEXwD">

                    <!-- Duration & Platform (버튼 위에 배치) -->
                    <div class="app-card">
                        <div class="form-group">
                            <label for="duration">영상 길이: <span id="duration-display">30</span>초</label>
                            <input type="range" id="duration" name="duration" min="30" max="300" value="30" step="10"
                                class="form-slider" />
                            <div class="slider-labels">
                                <span>30초</span><span>1분</span><span>2분</span><span>3분</span><span>5분</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label data-i18n="input.platform">플랫폼</label>
                            <div class="radio-group">
                                <label class="radio-card">
                                    <input type="radio" name="platform" value="youtube_long" checked>
                                    <span class="radio-card__inner">
                                        <span class="radio-card__icon">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
                                        </span>
                                        <span class="radio-card__label">YouTube Long (16:9)</span>
                                    </span>
                                </label>
                                <label class="radio-card">
                                    <input type="radio" name="platform" value="youtube_shorts">
                                    <span class="radio-card__inner">
                                        <span class="radio-card__icon">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2"/><path d="M12 18h.01"/></svg>
                                        </span>
                                        <span class="radio-card__label">YouTube Shorts (9:16)</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- ★ Submit button - prominent CTA -->
                    <button type="submit" class="btn-cta-generate" id="generate-story-btn">
                        <span class="btn-cta-generate__icon">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                        </span>
                        <span class="btn-cta-generate__text">
                            <strong data-i18n="input.generate">AI 시나리오 생성</strong>
                            <small>화자 분리 + 음성 선택 단계로 이동</small>
                        </span>
                        <span class="btn-cta-generate__arrow">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                        </span>
                    </button>

                </form>
            </div>
        </div>

        <!-- ══════════════════════════════════════
             STORY REVIEW SECTION
             ══════════════════════════════════════ -->
        <div id="review-section" class="section hidden">
            <div class="app-wide-container">
                <div class="app-section-header">
                    <span class="section-label" data-i18n="review.label">Step 2</span>
                    <h2 class="section-title" data-i18n="review.title">Scenario & Voice Selection</h2>
                    <p class="section-subtitle" data-i18n="review.subtitle">
                        Review the scenario, check detected speakers, and assign voices.
                        Edit narrations or visual descriptions freely, then proceed to image generation.
                    </p>
                </div>

                <div class="review-container">
                    <div class="story-meta-edit">
                        <label>Title</label>
                        <input type="text" id="review-title" class="form-input input-title" />
                    </div>

                    <!-- Speaker detection summary + voice assignment (injected by JS) -->
                    <div id="voice-selection-slot"></div>

                    <div id="review-scene-grid" class="review-scene-grid"></div>

                    <!-- 이미지 생성 옵션 (리뷰 단계에서 설정) -->
                    <details class="app-card app-accordion" open>
                        <summary class="app-accordion__trigger">
                            <span class="app-card-label">영상 생성 옵션</span>
                            <svg class="app-accordion__arrow" width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </summary>
                        <div class="app-accordion__content">
                            <div class="form-group">
                                <label for="image_model">이미지 모델</label>
                                <div class="select-wrapper">
                                    <select id="image_model" name="image_model" class="form-select">
                                        <option value="standard" selected>Standard (Gemini Flash) - 빠르고 안정적</option>
                                        <option value="premium">Premium (Gemini 3 Pro) - 고품질</option>
                                    </select>
                                </div>
                            </div>

                            <div class="toggle-grid">
                                <label class="toggle-item">
                                    <input type="checkbox" id="ffmpeg_kenburns" checked>
                                    <span class="toggle-switch"></span>
                                    <span class="toggle-label">
                                        <span>Ken Burns 효과</span>
                                        <small>이미지에 줌 & 패닝 효과</small>
                                    </span>
                                </label>
                                <label class="toggle-item">
                                    <input type="checkbox" id="ffmpeg_audio_ducking">
                                    <span class="toggle-switch"></span>
                                    <span class="toggle-label">
                                        <span>오디오 덕킹</span>
                                        <small>나레이션 시 BGM 자동 줄임</small>
                                    </span>
                                </label>
                                <label class="toggle-item">
                                    <input type="checkbox" id="subtitle_burn_in" checked>
                                    <span class="toggle-switch"></span>
                                    <span class="toggle-label">
                                        <span>자막</span>
                                        <small>영상에 자막 삽입</small>
                                    </span>
                                </label>
                                <label class="toggle-item">
                                    <input type="checkbox" id="context_carry_over" checked>
                                    <span class="toggle-switch"></span>
                                    <span class="toggle-label">
                                        <span>맥락 연결</span>
                                        <small>씬 간 시각적 일관성 유지</small>
                                    </span>
                                </label>
                                <label class="toggle-item">
                                    <input type="checkbox" id="optimization_pack">
                                    <span class="toggle-switch"></span>
                                    <span class="toggle-label">
                                        <span>최적화 팩</span>
                                        <small>제목, 썸네일, 해시태그 자동 생성</small>
                                    </span>
                                </label>
                                <label class="toggle-item">
                                    <input type="checkbox" id="film_look">
                                    <span class="toggle-switch"></span>
                                    <span class="toggle-label">
                                        <span>필름 룩</span>
                                        <small>필름 그레인 + 색보정 효과</small>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </details>

                    <div class="review-actions">
                        <button id="back-to-input-btn" class="btn btn-secondary" data-i18n="review.back">
                            Back to Settings
                        </button>
                        <button id="generate-images-btn" class="btn btn-primary btn-large" data-i18n="review.gen_images">
                            Generate Images (Step 2)
                        </button>
                        <button id="start-video-generation-btn" class="btn btn-secondary btn-large" data-i18n="review.skip_video">
                            Skip to Video (Skip Preview)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ══════════════════════════════════════
             IMAGE PREVIEW SECTION
             ══════════════════════════════════════ -->
        <div id="image-preview-section" class="section hidden">
            <div class="app-wide-container">
                <div class="app-section-header">
                    <span class="section-label" data-i18n="image.label">Step 3</span>
                    <h2 class="section-title" data-i18n="image.title">Image Review</h2>
                    <p class="section-subtitle" data-i18n="image.subtitle">
                        Review each scene's image. Regenerate or convert to I2V video as needed.
                    </p>
                </div>

                <!-- Image generation progress -->
                <div id="image-progress-container" class="progress-container hidden">
                    <div class="progress-header">
                        <span class="progress-label" id="image-progress-label">Generating images...</span>
                        <span class="progress-percentage" id="image-progress-percentage">0%</span>
                    </div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="image-progress-bar"></div>
                    </div>
                    <div class="status-message" id="image-status-message">Preparing...</div>
                </div>

                <div id="image-preview-grid" class="image-preview-grid"></div>
                <div id="image-test-result" class="image-test-result"></div>

                <div class="review-actions">
                    <button id="back-to-review-btn" class="btn btn-secondary" data-i18n="image.edit_story">
                        Edit Story
                    </button>
                    <!-- Test Image 버튼 제거 (API 엔드포인트 미구현) -->
                    <button id="test-image-btn" class="btn btn-secondary" onclick="app.testImageGeneration()" data-i18n="image.test" style="display:none">
                        Test Image
                    </button>
                    <button id="approve-images-btn" class="btn btn-primary btn-large" disabled data-i18n="image.approve">
                        Approve & Generate Video (Step 3)
                    </button>
                </div>
            </div>
        </div>

        <!-- ══════════════════════════════════════
             PROGRESS SECTION
             ══════════════════════════════════════ -->
        <div id="progress-section" class="section hidden">
            <div class="app-wide-container">
                <div class="app-section-header">
                    <h2 class="section-title" id="progress-title">Generating...</h2>
                </div>

                <div class="progress-container">
                    <div class="progress-header">
                        <span class="progress-label">Overall Progress</span>
                        <span class="progress-percentage" id="progress-percentage">0%</span>
                    </div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                    <div class="status-message" id="status-message">Initializing...</div>

                    <div class="steps-container" id="steps-container">
                        <div class="step" data-step="story">
                            <div class="step-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </div>
                            <div class="step-content">
                                <div class="step-title">Story Generation</div>
                                <div class="step-status">Waiting</div>
                            </div>
                        </div>
                        <div class="step" data-step="scenes">
                            <div class="step-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                            </div>
                            <div class="step-content">
                                <div class="step-title">Scene Processing</div>
                                <div class="step-status">Waiting</div>
                            </div>
                        </div>
                        <div class="step" data-step="compose">
                            <div class="step-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>
                            </div>
                            <div class="step-content">
                                <div class="step-title">Video Composition</div>
                                <div class="step-status">Waiting</div>
                            </div>
                        </div>
                        <div class="step" data-step="optimize">
                            <div class="step-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                            </div>
                            <div class="step-content">
                                <div class="step-title">Optimization</div>
                                <div class="step-status">Waiting</div>
                            </div>
                        </div>
                    </div>

                    <div class="preview-container hidden" id="preview-container">
                        <div class="visual-preview hidden" id="visual-preview">
                            <h3>Storyboard</h3>
                            <div class="scene-grid" id="scene-grid"></div>
                        </div>
                    </div>

                    <div class="log-container">
                        <div class="log-header">
                            <span>Live Log</span>
                            <button id="clear-log-btn" class="btn-small">Clear</button>
                        </div>
                        <div class="log-content" id="log-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ══════════════════════════════════════
             RESULT SECTION
             ══════════════════════════════════════ -->
        <div id="result-section" class="section hidden">
            <div class="app-wide-container">
                <div class="app-section-header">
                    <span class="section-label" data-i18n="result.label">Complete</span>
                    <h2 class="section-title" id="result-header-text" data-i18n="result.title">Video Ready!</h2>
                </div>

                <div class="result-container">
                    <div class="result-info">
                        <p><strong>Project ID:</strong> <code id="result-project-id"></code></p>
                        <p><strong>Title:</strong> <span id="result-title"></span></p>
                    </div>

                    <div class="video-player" id="result-video-container">
                        <video id="result-video" controls></video>
                    </div>

                    <div class="result-actions">
                        <a id="download-btn" class="btn btn-primary" download data-i18n="result.download">
                            Download Video
                        </a>
                        <button id="new-video-btn" class="btn btn-secondary" data-i18n="result.new_video">
                            New Video
                        </button>
                    </div>

                    <div id="scene-management" class="scene-management">
                        <h3 data-i18n="result.scene_mgmt">Scene Management</h3>
                        <p class="section-description" data-i18n="result.scene_desc">
                            Review individual scenes and regenerate as needed.
                            After changes, click "Recompose Video" to update the final video.
                        </p>
                        <div id="result-scene-grid" class="result-scene-grid"></div>
                        <div class="recompose-actions">
                            <button id="recompose-btn" class="btn btn-primary" style="display:none" data-i18n="result.recompose">
                                Recompose Video
                            </button>
                        </div>
                    </div>

                    <div id="optimization-pack" class="optimization-pack">
                        <h3>YouTube Optimization Pack</h3>
                        <div class="opt-section">
                            <h4>Title Candidates</h4>
                            <div id="title-candidates" class="candidate-list"></div>
                        </div>
                        <div class="opt-section">
                            <h4>Thumbnail Text</h4>
                            <div id="thumbnail-texts" class="candidate-list"></div>
                        </div>
                        <div class="opt-section">
                            <h4>Hashtags</h4>
                            <div id="hashtags" class="hashtag-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ══════════════════════════════════════
             MUSIC VIDEO SECTION
             ══════════════════════════════════════ -->
        <div id="mv-section" class="section hidden">
            <div class="app-form-container">
                <div class="app-section-header">
                    <span class="section-label" data-i18n="mv.label">Create</span>
                    <h2 class="section-title" data-i18n="mv.title">Music Video</h2>
                    <p class="section-subtitle" data-i18n="mv.subtitle">Upload music from Suno, Udio, etc. and AI creates a synced music video automatically.</p>
                </div>

                <form id="mv-form" class="app-form">
                    <!-- Upload -->
                    <div class="app-card">
                        <div class="form-group">
                            <label for="mv-music-file" data-i18n="mv.music_file">Music File</label>
                            <div class="file-dropzone" id="mv-dropzone">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                <span class="file-dropzone__text" data-i18n="mv.drop_text">Drop music file or click to browse</span>
                                <span class="file-dropzone__hint" data-i18n="mv.drop_hint">MP3, WAV, M4A, OGG, FLAC (max 10 min)</span>
                                <input type="file" id="mv-music-file" name="music_file"
                                    accept=".mp3,.wav,.m4a,.ogg,.flac" required />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="mv-lyrics" data-i18n="mv.lyrics_label">Lyrics (Optional)</label>
                            <textarea id="mv-lyrics" name="lyrics" class="form-input form-textarea" rows="5"
                                data-i18n-placeholder="mv.lyrics_placeholder"
                                placeholder="Enter lyrics for more accurate scene splitting..."></textarea>
                            <small class="helper-text" data-i18n="mv.lyrics_hint">Lyrics enable synced subtitle overlay</small>
                        </div>

                        <div class="form-group">
                            <label for="mv-concept" data-i18n="mv.concept_label">Visual Concept (Optional)</label>
                            <input type="text" id="mv-concept" name="concept" class="form-input"
                                data-i18n-placeholder="mv.concept_placeholder"
                                placeholder="e.g. Fairies dancing under moonlight, neon city streets..." />
                        </div>
                    </div>

                    <!-- Style Settings -->
                    <div class="app-card">
                        <div class="app-card-label" data-i18n="mv.style_settings">Style Settings</div>
                        <div class="form-grid-2">
                            <div class="form-group">
                                <label for="mv-character-setup" data-i18n="mv.characters">Characters</label>
                                <div class="select-wrapper">
                                    <select id="mv-character-setup" name="character_setup" class="form-select">
                                        <option value="auto" selected>AI Auto</option>
                                        <option value="male_female">Male-Female Couple</option>
                                        <option value="female_female">Female-Female Couple</option>
                                        <option value="male_male">Male-Male Couple</option>
                                        <option value="solo_male">Solo Male</option>
                                        <option value="solo_female">Solo Female</option>
                                        <option value="group">Group (3+)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="mv-character-ethnicity" data-i18n="mv.ethnicity">Ethnicity</label>
                                <div class="select-wrapper">
                                    <select id="mv-character-ethnicity" name="character_ethnicity" class="form-select">
                                        <option value="auto" selected>AI Auto</option>
                                        <option value="korean">Korean</option>
                                        <option value="japanese">Japanese</option>
                                        <option value="chinese">Chinese</option>
                                        <option value="southeast_asian">Southeast Asian</option>
                                        <option value="european">European</option>
                                        <option value="black">Black</option>
                                        <option value="hispanic">Hispanic</option>
                                        <option value="mixed">Mixed</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-grid-2">
                            <div class="form-group">
                                <label for="mv-genre" data-i18n="mv.genre">Genre</label>
                                <div class="select-wrapper">
                                    <select id="mv-genre" name="genre" class="form-select">
                                        <option value="fantasy" selected>Fantasy</option>
                                        <option value="romance">Romance</option>
                                        <option value="action">Action</option>
                                        <option value="horror">Horror</option>
                                        <option value="scifi">Sci-Fi</option>
                                        <option value="drama">Drama</option>
                                        <option value="comedy">Comedy</option>
                                        <option value="abstract">Abstract</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="mv-mood" data-i18n="mv.mood">Mood</label>
                                <div class="select-wrapper">
                                    <select id="mv-mood" name="mood" class="form-select">
                                        <option value="epic" selected>Epic</option>
                                        <option value="dreamy">Dreamy</option>
                                        <option value="energetic">Energetic</option>
                                        <option value="calm">Calm</option>
                                        <option value="dark">Dark</option>
                                        <option value="romantic">Romantic</option>
                                        <option value="melancholic">Melancholic</option>
                                        <option value="uplifting">Uplifting</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="mv-style" data-i18n="mv.style">Visual Style</label>
                            <div class="select-wrapper">
                                <select id="mv-style" name="style" class="form-select">
                                    <option value="cinematic" selected>Cinematic</option>
                                    <option value="anime">Anime</option>
                                    <option value="webtoon">Webtoon</option>
                                    <option value="realistic">Realistic</option>
                                    <option value="illustration">Illustration</option>
                                    <option value="abstract">Abstract</option>
                                    <option value="game_anime">Game Anime</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- MV Options -->
                    <div class="app-card">
                        <div class="app-card-label" data-i18n="mv.options">Options</div>
                        <div class="toggle-grid">
                            <label class="toggle-item">
                                <input type="checkbox" id="mv-subtitle-enabled" checked>
                                <span class="toggle-switch"></span>
                                <span class="toggle-label">
                                    <span data-i18n="mv_toggle.lyrics">Lyric Subtitles</span>
                                    <small data-i18n="mv_toggle.lyrics_desc">Overlay lyrics on video</small>
                                </span>
                            </label>
                            <label class="toggle-item">
                                <input type="checkbox" id="mv-quick-test">
                                <span class="toggle-switch"></span>
                                <span class="toggle-label">
                                    <span data-i18n="mv_toggle.quick">Quick Test (45s preview)</span>
                                    <small data-i18n="mv_toggle.quick_desc">Fast preview - first 45 seconds only</small>
                                </span>
                            </label>
                            <label class="toggle-item">
                                <input type="checkbox" id="mv-subtitle-only">
                                <span class="toggle-switch"></span>
                                <span class="toggle-label">
                                    <span data-i18n="mv_toggle.sub_only">Subtitle Only Test</span>
                                    <small data-i18n="mv_toggle.sub_only_desc">Test subtitle sync on black background</small>
                                </span>
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-submit" id="mv-upload-btn">
                        <span data-i18n="mv.generate">Generate Music Video</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                    </button>
                </form>
            </div>
        </div>

        <!-- ══════════════════════════════════════
             MV ANALYSIS SECTION
             ══════════════════════════════════════ -->
        <div id="mv-analysis-section" class="section hidden">
            <div class="app-wide-container">
                <div class="app-section-header">
                    <span class="section-label" data-i18n="mva.label">Analysis</span>
                    <h2 class="section-title" data-i18n="mva.title">Music Analysis</h2>
                </div>

                <div class="mv-analysis-info">
                    <div class="mv-stats-grid">
                        <div class="mv-stat-card">
                            <span class="mv-stat-label" data-i18n="mva.duration">Duration</span>
                            <span class="mv-stat-value" id="mv-duration">0:00</span>
                        </div>
                        <div class="mv-stat-card">
                            <span class="mv-stat-label">BPM</span>
                            <span class="mv-stat-value" id="mv-bpm">-</span>
                        </div>
                        <div class="mv-stat-card">
                            <span class="mv-stat-label" data-i18n="mva.scenes">Scenes</span>
                            <span class="mv-stat-value" id="mv-suggested-scenes">-</span>
                        </div>
                        <div class="mv-stat-card">
                            <span class="mv-stat-label" data-i18n="mva.mood">Mood</span>
                            <span class="mv-stat-value" id="mv-detected-mood">-</span>
                        </div>
                    </div>
                </div>

                <div class="mv-scene-editor-section">
                    <h3 class="mv-editor-title" data-i18n="mva.editor">Scene Editor</h3>
                    <p class="section-description" data-i18n="mva.editor_desc">
                        Review auto-split scenes. Add descriptions for more accurate visuals.
                    </p>
                    <div id="mv-scene-editor" class="mv-scene-editor-list"></div>
                </div>

                <div class="review-actions review-actions--center">
                    <button id="mv-back-btn" class="btn btn-secondary" data-i18n="mva.reupload">
                        Re-upload
                    </button>
                    <button id="mv-subtitle-test-btn" class="btn btn-secondary" data-i18n="mva.sub_test">
                        Subtitle Test
                    </button>
                    <button id="mv-generate-btn" class="btn btn-primary btn-large" data-i18n="mva.start">
                        Start MV Generation
                    </button>
                </div>
            </div>
        </div>

        <!-- ══════════════════════════════════════
             MV PROGRESS SECTION
             ══════════════════════════════════════ -->
        <div id="mv-progress-section" class="section hidden">
            <div class="app-wide-container">
                <div class="app-section-header">
                    <h2 class="section-title" id="mv-progress-title">Generating MV...</h2>
                </div>

                <div class="progress-container">
                    <div class="progress-header">
                        <span class="progress-label">Overall Progress</span>
                        <span class="progress-percentage" id="mv-progress-percentage">0%</span>
                    </div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="mv-progress-bar"></div>
                    </div>
                    <div class="status-message" id="mv-status-message">Initializing...</div>
                    <button id="mv-cancel-btn" class="btn btn-danger btn-small">Cancel</button>

                    <div class="steps-container" id="mv-steps-container">
                        <div class="step" data-step="analyze">
                            <div class="step-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                            </div>
                            <div class="step-content">
                                <div class="step-title">Music Analysis</div>
                                <div class="step-status">Complete</div>
                            </div>
                        </div>
                        <div class="step" data-step="scenes">
                            <div class="step-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </div>
                            <div class="step-content">
                                <div class="step-title">Scene Prompts</div>
                                <div class="step-status">Waiting</div>
                            </div>
                        </div>
                        <div class="step" data-step="images">
                            <div class="step-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                            </div>
                            <div class="step-content">
                                <div class="step-title">Image Generation</div>
                                <div class="step-status">Waiting</div>
                            </div>
                        </div>
                        <div class="step" data-step="compose">
                            <div class="step-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>
                            </div>
                            <div class="step-content">
                                <div class="step-title">Video Composition</div>
                                <div class="step-status">Waiting</div>
                            </div>
                        </div>
                    </div>

                    <div id="mv-scene-preview" class="mv-scene-preview-area">
                        <h3 class="mv-editor-title">Generated Scenes</h3>
                        <div id="mv-scene-grid" class="scene-grid"></div>
                    </div>

                    <div class="log-container">
                        <div class="log-header">
                            <span>Live Log</span>
                            <button id="mv-clear-log-btn" class="btn-small">Clear</button>
                        </div>
                        <div class="log-content" id="mv-log-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ══════════════════════════════════════
             MV IMAGE REVIEW / EDITOR SECTION
             ══════════════════════════════════════ -->
        <div id="mv-image-review-section" class="section hidden">
            <div class="app-wide-container">
                <div class="app-section-header">
                    <span class="section-label" data-i18n="mvr.label">Music Video</span>
                    <h2 class="section-title" id="mv-editor-header">Scene Images</h2>
                </div>

                <!-- Video area (shown when complete) -->
                <div id="mv-editor-video-area" class="mv-editor-video-area" style="display:none">
                    <div class="result-container">
                        <div class="video-player">
                            <video id="mv-editor-video" controls></video>
                        </div>
                        <div class="result-actions">
                            <a id="mv-editor-download-btn" class="btn btn-primary" download data-i18n="mvr.download">
                                Download MV
                            </a>
                            <label id="mv-editor-music-upload-btn" class="btn btn-secondary" style="display:none">
                                Re-upload Music
                                <input type="file" accept=".mp3,.wav,.m4a,.ogg,.flac" class="sr-only"
                                       onchange="app.mvUploadMusicForRecompose(this.files[0])">
                            </label>
                            <button id="mv-editor-recompose-btn" class="btn btn-secondary" style="display:none"
                                    onclick="app.mvRecompose()">
                                Recompose Video
                            </button>
                        </div>
                    </div>
                </div>

                <p id="mv-editor-description" class="section-description" data-i18n="mvr.desc">
                    Review scene images. Regenerate any scenes you don't like, or create I2V video clips.
                </p>
                <div id="mv-image-review-grid" class="result-scene-grid"></div>
                <div id="mv-editor-bottom-actions" class="review-actions review-actions--center">
                    <button id="mv-compose-btn" class="btn btn-primary btn-large" data-i18n="mvr.compose">
                        Generate Final MV
                    </button>
                    <button class="btn btn-secondary" onclick="app.resetMVUI()" data-i18n="mvr.new_mv">
                        New Music Video
                    </button>
                </div>

                <!-- Lyrics Timeline Editor Modal -->
                <div id="lyrics-timeline-overlay" class="lyrics-timeline-overlay">
                    <div class="lyrics-timeline-modal">
                        <div class="lyrics-timeline-header">
                            <h3>Lyrics Timeline Editor</h3>
                            <button class="lyrics-timeline-close" onclick="app.closeLyricsTimeline()">&times;</button>
                        </div>
                        <div class="lyrics-timeline-body">
                            <table class="lyrics-timeline-table">
                                <thead>
                                    <tr>
                                        <th class="col-time">Time</th>
                                        <th class="col-stt">STT</th>
                                        <th class="col-lyrics">Subtitle Text</th>
                                        <th class="col-del"></th>
                                    </tr>
                                </thead>
                                <tbody id="lyrics-timeline-tbody"></tbody>
                            </table>
                        </div>
                        <div class="lyrics-timeline-footer">
                            <div class="footer-left">
                                <button class="btn-tl-add" onclick="app.timelineAddRow()">+ Add Row</button>
                            </div>
                            <div class="footer-right">
                                <button class="btn-tl-reset" onclick="app.timelineReset()">Reset</button>
                                <button id="btn-tl-save" class="btn-tl-save" onclick="app.timelineSave()">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ══════════════════════════════════════
             HISTORY SECTION
             ══════════════════════════════════════ -->
        <div id="history-section" class="section hidden">
            <div class="app-wide-container">
                <div class="app-section-header">
                    <span class="section-label" data-i18n="history.label">Library</span>
                    <h2 class="section-title" data-i18n="history.title">My Videos</h2>
                </div>

                <div class="history-container">
                    <div class="retention-notice" data-i18n="history.retention">
                        Images are auto-deleted at 3 AM next day. Final videos are deleted after 3 days.
                        Please download important videos in advance.
                    </div>
                    <div class="history-toolbar">
                        <div class="history-filter-tabs">
                            <button class="history-filter-btn active" data-filter="all">All</button>
                            <button class="history-filter-btn" data-filter="video">Video</button>
                            <button class="history-filter-btn" data-filter="mv">MV</button>
                        </div>
                        <button id="refresh-history-btn" class="btn btn-secondary btn-small" data-i18n="history.refresh">
                            Refresh
                        </button>
                    </div>
                    <div id="history-grid" class="history-grid"></div>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="app-footer">
        <p>&copy; 2025 Klippa | AI Video Creation Studio</p>
        <p><a href="/docs" target="_blank">API Docs</a></p>
    </footer>

    <script src="/static/app.js?v=20260216_1210"></script>
    <script>
    // ─── App i18n (synced with landing page via localStorage) ───
    (function() {
      const T = {
        ko: {
          // Nav
          'nav.create': '새 영상', 'nav.mv': '뮤직비디오', 'nav.history': '내 영상',
          'nav.pricing': '요금제',
          // Input section
          'input.label': '만들기', 'input.title': '새 영상',
          'input.subtitle': '주제를 입력하면 AI가 내레이션, 이미지, 효과가 포함된 영상을 자동 생성합니다.',
          'input.mode_ai': 'AI 스토리', 'input.mode_script': '직접 입력',
          'input.topic_label': '주제 / 아이디어',
          'input.topic_placeholder': '예: 오래된 폐병원에서 발견된 미스터리 일기장',
          'input.topic_hint': '비워두면 AI가 자동으로 주제를 생성합니다',
          'input.script_label': '내레이션 스크립트',
          'input.script_placeholder': '내레이션 스크립트를 붙여넣으세요.\n\n빈 줄로 씬을 구분합니다.\n\n예시:\n망해가는 상가 속 번창하는 가게.\n비즈니스 랩에 오신 걸 환영합니다.\n\n지난번 소개한 매장은\n엄청난 반응을 얻었습니다.',
          'input.script_hint': '빈 줄로 씬을 구분하세요. AI가 각 씬에 맞는 이미지를 생성합니다.',
          'input.style_genre': '스타일 & 장르',
          'input.genre': '장르', 'input.mood': '분위기',
          'input.style': '비주얼 스타일', 'input.ethnicity': '캐릭터 인종',
          'input.voice_duration': '음성 & 길이',
          'input.voice': '음성 (TTS)', 'input.sample': '미리듣기',
          'input.platform': '플랫폼',
          'input.advanced': '고급 설정', 'input.image_model': '이미지 모델',
          'input.generate': '스토리 생성',
          // Review
          'review.label': '2단계', 'review.title': '스토리 검토',
          'review.subtitle': 'AI가 생성한 스토리를 검토하세요. 내레이션이나 비주얼 설명을 자유롭게 편집한 뒤 이미지 생성으로 진행하세요.',
          'review.back': '설정으로 돌아가기',
          'review.gen_images': '이미지 생성 (2단계)',
          'review.skip_video': '영상으로 건너뛰기',
          // Image preview
          'image.label': '3단계', 'image.title': '이미지 검토',
          'image.subtitle': '각 씬의 이미지를 검토하세요. 재생성하거나 I2V 영상으로 변환할 수 있습니다.',
          'image.edit_story': '스토리 편집',
          'image.test': '테스트 이미지',
          'image.approve': '승인 & 영상 생성 (3단계)',
          // Result
          'result.label': '완료', 'result.title': '영상 완성!',
          'result.download': '영상 다운로드', 'result.new_video': '새 영상',
          'result.scene_mgmt': '씬 관리',
          'result.scene_desc': '개별 씬을 검토하고 필요한 것을 재생성하세요. 변경 후 "영상 재합성"을 클릭하면 최종 영상이 업데이트됩니다.',
          'result.recompose': '영상 재합성',
          // MV
          'mv.label': '만들기', 'mv.title': '뮤직비디오',
          'mv.subtitle': 'Suno, Udio 등의 음악을 업로드하면 AI가 싱크된 뮤직비디오를 자동 제작합니다.',
          'mv.music_file': '음악 파일',
          'mv.drop_text': '음악 파일을 드래그하거나 클릭해서 선택',
          'mv.drop_hint': 'MP3, WAV, M4A, OGG, FLAC (최대 10분)',
          'mv.lyrics_label': '가사 (선택)',
          'mv.lyrics_placeholder': '더 정확한 씬 분할을 위해 가사를 입력하세요...',
          'mv.lyrics_hint': '가사를 입력하면 싱크된 자막이 오버레이됩니다',
          'mv.concept_label': '비주얼 컨셉 (선택)',
          'mv.concept_placeholder': '예: 달빛 아래 춤추는 요정들, 네온 도시의 거리...',
          'mv.style_settings': '스타일 설정',
          'mv.characters': '캐릭터', 'mv.ethnicity': '인종',
          'mv.genre': '장르', 'mv.mood': '분위기', 'mv.style': '비주얼 스타일',
          'mv.options': '옵션',
          'mv.generate': '뮤직비디오 생성',
          // MV toggles
          'mv_toggle.lyrics': '가사 자막', 'mv_toggle.lyrics_desc': '영상에 가사 오버레이',
          'mv_toggle.quick': '빠른 테스트 (45초 미리보기)', 'mv_toggle.quick_desc': '빠른 미리보기 - 처음 45초만',
          'mv_toggle.sub_only': '자막 전용 테스트', 'mv_toggle.sub_only_desc': '검정 배경에서 자막 싱크 테스트',
          // Advanced toggles
          'toggle.kenburns': 'Ken Burns 효과', 'toggle.kenburns_desc': '이미지에 줌 & 패닝',
          'toggle.ducking': '오디오 덕킹', 'toggle.ducking_desc': '내레이션 시 BGM 자동 줄임',
          'toggle.subtitles': '자막', 'toggle.subtitles_desc': '영상에 자막 삽입',
          'toggle.context': '맥락 이어가기', 'toggle.context_desc': '씬 간 일관성 유지',
          'toggle.optimize': '최적화 패키지', 'toggle.optimize_desc': '제목, 썸네일, 해시태그 자동 생성',
          // MV Analysis
          'mva.label': '분석', 'mva.title': '음악 분석',
          'mva.duration': '길이', 'mva.scenes': '씬 수', 'mva.mood': '분위기',
          'mva.editor': '씬 에디터', 'mva.editor_desc': '자동 분할된 씬을 검토하세요. 설명을 추가하면 더 정확한 비주얼이 생성됩니다.',
          'mva.reupload': '다시 업로드', 'mva.sub_test': '자막 테스트', 'mva.start': 'MV 생성 시작',
          // MV Review
          'mvr.label': '뮤직비디오',
          'mvr.download': 'MV 다운로드', 'mvr.desc': '씬 이미지를 검토하세요. 마음에 들지 않는 씬은 재생성하거나 I2V 영상 클립으로 변환할 수 있습니다.',
          'mvr.compose': '최종 MV 생성', 'mvr.new_mv': '새 뮤직비디오',
          // History
          'history.label': '라이브러리', 'history.title': '내 영상',
          'history.retention': '이미지는 다음날 새벽 3시에 자동 삭제됩니다. 최종 영상은 3일 후 삭제됩니다. 중요한 영상은 미리 다운로드하세요.',
          'history.refresh': '새로고침',
        },
        en: {}  // English is the HTML default, no overrides needed
      };

      function applyLang(lang) {
        const dict = T[lang] || {};
        if (lang === 'en') return; // HTML already in English
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          if (dict[key]) el.textContent = dict[key];
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
          const key = el.getAttribute('data-i18n-placeholder');
          if (dict[key]) el.placeholder = dict[key];
        });
      }

      const lang = localStorage.getItem('klippa_lang') || 'ko';
      if (lang !== 'en') applyLang(lang);
    })();
    </script>
</body>

</html>